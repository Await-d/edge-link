# 告警去重系统架构图

## 1. 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        Alert Service                            │
│                                                                   │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐      │
│  │ Threshold    │───▶│    Alert     │───▶│ Notification │      │
│  │   Checker    │    │  Generator   │    │  Scheduler   │      │
│  └──────────────┘    └───────┬──────┘    └──────────────┘      │
│                              │                                   │
│                              ▼                                   │
│                      ┌───────────────┐                          │
│                      │ Deduplication │                          │
│                      │    Manager    │                          │
│                      └───────┬───────┘                          │
└──────────────────────────────┼──────────────────────────────────┘
                               │
                   ┌───────────┴───────────┐
                   │                       │
                   ▼                       ▼
          ┌────────────────┐      ┌────────────────┐
          │  PostgreSQL    │      │     Redis      │
          │                │      │                │
          │  - alerts表    │      │  - 去重信息    │
          │  - occurrence  │      │  - 分布式锁    │
          │  - timestamps  │      │  - 静默标记    │
          └────────────────┘      └────────────────┘
```

## 2. 去重流程图

```
                    告警触发
                       │
                       ▼
              ┌────────────────┐
              │  生成AlertKey  │
              │ (设备ID+类型)  │
              └────────┬───────┘
                       │
                       ▼
              ┌────────────────┐
              │ 检查静默期？   │
              └────┬─────┬─────┘
                   │     │
              YES  │     │  NO
                   │     │
                   ▼     ▼
              ┌────┐  ┌────────────────┐
              │跳过│  │ 获取分布式锁   │
              └────┘  └────────┬───────┘
                               │
                               ▼
                      ┌────────────────┐
                      │Redis中存在？   │
                      └────┬─────┬─────┘
                           │     │
                      NO   │     │  YES
                           │     │
                           ▼     ▼
                  ┌──────────┐ ┌──────────────┐
                  │创建新告警│ │在时间窗口内？│
                  └──────┬───┘ └───┬────┬─────┘
                         │         │    │
                         │    YES  │    │  NO
                         │         │    │
                         │         ▼    ▼
                         │    ┌────────┐ ┌──────────┐
                         │    │更新告警│ │创建新告警│
                         │    │+count  │ └──────────┘
                         │    └────┬───┘
                         │         │
                         │         ▼
                         │    ┌────────────┐
                         │    │count>=阈值?│
                         │    └────┬──┬────┘
                         │         │  │
                         │    YES  │  │  NO
                         │         │  │
                         │         ▼  │
                         │    ┌────────┐
                         │    │升级严重│
                         │    │  程度  │
                         │    └────┬───┘
                         │         │
                         └─────────┴─────────▶ 发送通知
```

## 3. Redis数据结构

```
Redis Key-Value 结构：

┌─────────────────────────────────────────────────────────────┐
│ Key: alert:dedupe:{hash}                                    │
│ TTL: 60分钟（2×DedupeWindow）                              │
├─────────────────────────────────────────────────────────────┤
│ Value (JSON):                                               │
│ {                                                           │
│   "alert_id": "550e8400-e29b-41d4-a716-446655440000",      │
│   "device_id": "123e4567-e89b-12d3-a456-426614174000",     │
│   "alert_type": "device_offline",                          │
│   "first_seen_at": "2025-10-20T10:00:00Z",                 │
│   "last_seen_at": "2025-10-20T10:30:00Z",                  │
│   "occurrence_count": 15,                                   │
│   "current_severity": "high",                               │
│   "escalated": true                                         │
│ }                                                           │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ Key: alert:lock:{hash}                                      │
│ TTL: 5秒（LockTimeout）                                    │
├─────────────────────────────────────────────────────────────┤
│ Value: "1"                                                  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ Key: alert:silent:{hash}                                    │
│ TTL: 5分钟（SilentPeriod）                                 │
├─────────────────────────────────────────────────────────────┤
│ Value: "1"                                                  │
└─────────────────────────────────────────────────────────────┘
```

## 4. 数据库Schema变更

```sql
alerts 表结构：

┌─────────────────────┬──────────────┬────────────┬─────────────┐
│ 字段名              │ 类型         │ 默认值     │ 说明        │
├─────────────────────┼──────────────┼────────────┼─────────────┤
│ id                  │ UUID         │ gen_rand() │ 主键        │
│ device_id           │ UUID         │ NULL       │ 设备ID      │
│ severity            │ ENUM         │ -          │ 严重程度    │
│ type                │ ENUM         │ -          │ 告警类型    │
│ title               │ VARCHAR(255) │ -          │ 标题        │
│ message             │ TEXT         │ -          │ 消息        │
│ metadata            │ JSONB        │ {}         │ 元数据      │
│ status              │ ENUM         │ active     │ 状态        │
│ acknowledged_by     │ UUID         │ NULL       │ 确认人      │
│ acknowledged_at     │ TIMESTAMP    │ NULL       │ 确认时间    │
│ resolved_at         │ TIMESTAMP    │ NULL       │ 解决时间    │
│ ────────────────────┴──────────────┴────────────┴─────────────│
│ *** 新增去重字段 ***                                          │
│ occurrence_count    │ INTEGER      │ 1          │ 出现次数 ⭐  │
│ first_seen_at       │ TIMESTAMP    │ NOW()      │ 首次出现 ⭐  │
│ last_seen_at        │ TIMESTAMP    │ NOW()      │ 最后出现 ⭐  │
│ ────────────────────┴──────────────┴────────────┴─────────────│
│ created_at          │ TIMESTAMP    │ NOW()      │ 创建时间    │
│ updated_at          │ TIMESTAMP    │ NOW()      │ 更新时间    │
└─────────────────────┴──────────────┴────────────┴─────────────┘

新增索引：
┌─────────────────────────────────────────────────────────────┐
│ idx_alerts_last_seen_at         ON (last_seen_at)          │
│ idx_alerts_device_type_status   ON (device_id, type, status)│
└─────────────────────────────────────────────────────────────┘
```

## 5. 时间线示例

```
时间轴：告警生命周期示例

T=0min      设备A离线
            ↓
            [创建告警] ID=alert-1, count=1
            ↓ 保存到DB和Redis
            ↓ 发送通知

T=5min      设备A仍离线
            ↓
            [更新告警] ID=alert-1, count=2
            ↓ 更新last_seen_at
            ↓ 不发送新通知

T=10min     设备A仍离线
            ↓
            [更新告警] ID=alert-1, count=3
            ...

T=50min     设备A仍离线
            ↓
            [更新告警] ID=alert-1, count=11
            ↓ count >= 10 (阈值)
            ↓ [升级] severity: medium → high
            ↓ 发送升级通知

T=55min     设备A恢复在线
            ↓
            [自动解决] status: active → resolved
            ↓ 删除Redis去重信息
            ↓ 设置静默期（5分钟）

T=57min     设备A再次离线
            ↓
            [检查静默期] → 跳过
            ↓ 不创建新告警

T=62min     静默期结束，设备A仍离线
            ↓
            [创建新告警] ID=alert-2, count=1
            ↓ 开始新的生命周期
```

## 6. 配置参数影响

```
参数调整对系统行为的影响：

┌─────────────────────┬──────────┬────────────────────────┐
│ 参数                │ 默认值   │ 影响                   │
├─────────────────────┼──────────┼────────────────────────┤
│ DEDUPE_WINDOW       │ 30m      │ 越大 → 合并更多告警    │
│                     │          │ 越小 → 告警更独立      │
├─────────────────────┼──────────┼────────────────────────┤
│ SILENT_PERIOD       │ 5m       │ 越大 → 减少抖动告警    │
│                     │          │ 越小 → 响应更快        │
├─────────────────────┼──────────┼────────────────────────┤
│ ESCALATION_THRESHOLD│ 10       │ 越大 → 升级更保守      │
│                     │          │ 越小 → 升级更激进      │
├─────────────────────┼──────────┼────────────────────────┤
│ CHECK_INTERVAL      │ 1m       │ 越小 → 检测更及时      │
│                     │          │ 越大 → 资源占用更少    │
└─────────────────────┴──────────┴────────────────────────┘

推荐配置方案：

小规模（<100设备）:
  DEDUPE_WINDOW=30m, CHECK_INTERVAL=1m

中等规模（100-1000设备）:
  DEDUPE_WINDOW=15m, CHECK_INTERVAL=2m

大规模（>1000设备）:
  DEDUPE_WINDOW=10m, CHECK_INTERVAL=5m, REDIS_POOL_SIZE=50
```

## 7. 性能特征

```
系统性能指标：

┌─────────────────────────────────────────────────────────┐
│ 吞吐量                                                  │
│   单实例: ~1000 告警/秒                                 │
│   多实例: 线性扩展（通过分布式锁协调）                 │
├─────────────────────────────────────────────────────────┤
│ 延迟                                                    │
│   Redis操作: < 2ms                                      │
│   数据库操作: < 10ms                                    │
│   总体延迟: < 20ms/告警                                 │
├─────────────────────────────────────────────────────────┤
│ 内存占用（Redis）                                       │
│   每个去重键: ~300 bytes                                │
│   1000活跃告警: ~300 KB                                 │
│   10000活跃告警: ~3 MB                                  │
├─────────────────────────────────────────────────────────┤
│ 并发安全                                                │
│   分布式锁: 防止重复创建                                │
│   锁超时: 5秒自动释放                                   │
│   故障降级: Redis故障时仍创建告警                       │
└─────────────────────────────────────────────────────────┘
```
