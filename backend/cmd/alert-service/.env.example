# Alert Service Configuration Example
# 告警服务配置示例

# ==================== 告警去重配置 ====================

# 去重时间窗口（同一设备的相同告警类型在此时间内只保留一条）
# 格式: 数字+单位 (s=秒, m=分钟, h=小时)
# 默认: 30m
ALERT_DEDUPE_WINDOW=30m

# 静默期（告警解决后，多长时间内不再生成相同告警）
# 用于避免设备频繁上下线导致的告警风暴
# 默认: 5m
ALERT_SILENT_PERIOD=5m

# 告警升级阈值（告警出现次数超过此值时，自动提升严重程度）
# 例如: medium -> high -> critical
# 默认: 10
ALERT_ESCALATION_THRESHOLD=10

# 分布式锁超时时间（防止并发创建重复告警）
# 默认: 5s
ALERT_LOCK_TIMEOUT=5s

# ==================== 告警检查配置 ====================

# 告警检查间隔（多久执行一次健康检查）
# 默认: 1m
ALERT_CHECK_INTERVAL=1m

# 设备离线阈值（设备多长时间未上报心跳视为离线）
# 默认: 5m
ALERT_DEVICE_OFFLINE_THRESHOLD=5m

# 高延迟阈值（会话延迟超过此值（毫秒）触发告警）
# 默认: 200
ALERT_HIGH_LATENCY_THRESHOLD=200

# ==================== Redis配置 ====================

REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=edgelink_redis_password
REDIS_DB=0
REDIS_POOL_SIZE=10

# ==================== 数据库配置 ====================

DB_HOST=localhost
DB_PORT=5432
DB_USER=edgelink
DB_PASSWORD=edgelink_dev_password
DB_NAME=edgelink
DB_SSLMODE=disable

# ==================== 日志配置 ====================

LOG_LEVEL=info
LOG_FORMAT=json
LOG_OUTPUT=stdout

# ==================== 告警去重工作流程说明 ====================
#
# 1. 检查阶段：
#    - 每隔 ALERT_CHECK_INTERVAL 执行一次健康检查
#    - 检测设备离线、高延迟、连接失败等问题
#
# 2. 去重阶段：
#    - 使用 设备ID + 告警类型 作为唯一键
#    - 在 ALERT_DEDUPE_WINDOW 时间窗口内，相同键的告警会被合并
#    - 使用Redis分布式锁防止并发创建
#
# 3. 告警处理：
#    a) 新告警：创建数据库记录，occurrence_count=1
#    b) 重复告警：更新 occurrence_count 和 last_seen_at
#    c) 告警升级：当 occurrence_count >= ALERT_ESCALATION_THRESHOLD 时提升严重程度
#
# 4. 自动解决：
#    - 当设备恢复在线时，自动解决离线告警
#    - 设置 ALERT_SILENT_PERIOD 静默期，避免告警风暴
#
# 5. Redis数据结构：
#    - alert:dedupe:{hash}    -> AlertDedupeInfo (JSON，TTL=2*DEDUPE_WINDOW)
#    - alert:lock:{hash}      -> "1" (分布式锁，TTL=LOCK_TIMEOUT)
#    - alert:silent:{hash}    -> "1" (静默标记，TTL=SILENT_PERIOD)
#
# ==================== 性能调优建议 ====================
#
# 低流量环境（< 100设备）：
#   ALERT_CHECK_INTERVAL=1m
#   ALERT_DEDUPE_WINDOW=30m
#
# 中等流量（100-1000设备）：
#   ALERT_CHECK_INTERVAL=2m
#   ALERT_DEDUPE_WINDOW=15m
#
# 高流量（> 1000设备）：
#   ALERT_CHECK_INTERVAL=5m
#   ALERT_DEDUPE_WINDOW=10m
#   建议增加Redis连接池: REDIS_POOL_SIZE=50
